{% extends "base.html" %}

{% block title %}Add Application{% endblock %}

{% block content %}

<h1 style="text-align:center; margin-bottom:1.5rem;">Add New Application</h1>

<div class="form-container">

    <form method="POST">

        <!-- UNIVERSITY & COURSE INFO -->
        <h2 class="form-section-title">University & Course Details</h2>

        <div class="form-group typeahead">
            <label>Country</label>
            <input type="text" id="country_name" name="country_name" autocomplete="off" required>
            <div class="dropdown-list" id="country_dropdown"></div>
        </div>


        <div class="form-group typeahead">
            <label>University Name</label>
            <input type="text" id="university_name" name="university_name" autocomplete="off" required>
            <div class="dropdown-list" id="university_dropdown"></div>
        </div>


        <div class="form-group">
            <label>Course Name</label>
            <input type="text" name="course_name" required>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Degree Type</label>
                <input type="text" name="degree_type">
            </div>

            <div class="form-group">
                <label>Course URL</label>
                <input type="text" name="course_url">
            </div>
        </div>

        <!-- INTAKE & DEADLINES -->
        <h2 class="form-section-title">Intake & Deadlines</h2>

        <div class="form-row">
            <div class="form-group">
                <label>Intake Type</label>
                <select name="intake_type">
                    <option value=""></option>
                    <option value="Winter">Winter</option>
                    <option value="Summer">Summer</option>
                </select>
            </div>

            <div class="form-group">
                <label>Intake Year</label>
                <input type="number" name="intake_year" min="2024" max="2035">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Application Opens</label>
                <input type="date" name="application_open_date">
            </div>

            <div class="form-group">
                <label>Deadline</label>
                <input type="date" name="deadline_date">
            </div>
        </div>

        <!-- REQUIREMENTS -->
        <h2 class="form-section-title">Requirements</h2>

        <div class="form-row">
            <div class="form-group">
                <label>IELTS Required</label>
                <input type="number" step="0.5" name="ielts_required">
            </div>

            <div class="form-group">
                <label>German Required</label>
                <input type="text" name="german_required">
            </div>
        </div>

        <div class="form-group">
            <label>Extra Requirements</label>
            <textarea name="extra_requirements"></textarea>
        </div>

        <!-- APPLICATION MODE -->
        <h2 class="form-section-title">Application Mode</h2>

        <div class="form-row">
            <div class="form-group">
                <label>Mode</label>
                <select name="application_mode">
                    <option value=""></option>
                    <option value="Direct">Direct</option>
                    <option value="UniAssist">UniAssist</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        
            <div class="form-group">
                <label>Portal Email</label>
                <input type="email" name="portal_email">
            </div>
        
            <div class="form-group">
                <label>Password Hint</label>
                <input type="text" name="portal_password_hint">
            </div>
        </div>

        <!-- STATUS & SUBMISSION INFO -->
        <h2 class="form-section-title">Status & Submission</h2>

        <div class="form-group">
            <label>Status</label>
            <select name="status" id="status" required>
                <option value=""></option>
                <option value="shortlisted">Shortlisted</option>
                <option value="preparing">Preparing</option>
                <option value="submitted">Submitted</option>
                <option value="admitted">Admitted</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Date Submitted</label>
                <input type="date" name="date_submitted" id="date_submitted" disabled>
            </div>
        
            <div class="form-group">
                <label>Time Submitted</label>
                <input type="time" name="time_submitted" id="time_submitted" disabled>
            </div>
        
            <div class="form-group">
                <label>Decision Date</label>
                <input type="date" name="decision_date" id="decision_date" disabled>
            </div>
        </div>

        <!-- EXTRA INFO -->
        <h2 class="form-section-title">Extra Info</h2>

        <div class="form-group">
            <textarea name="extra_info"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Save Application</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline">Cancel</a>

    </form>

</div>

<script>
// Reusable function for dropdown typeahead
function setupTypeahead(inputId, dropdownId, apiUrl) {
    const inputEl = document.getElementById(inputId);
    const dropdownEl = document.getElementById(dropdownId);

    inputEl.addEventListener("input", function () {
        let q = inputEl.value.trim();

        if (q.length < 1) {
            dropdownEl.style.display = "none";
            return;
        }

        fetch(`${apiUrl}?q=` + q)
            .then(res => res.json())
            .then(items => {
                dropdownEl.innerHTML = "";

                items.forEach(item => {
                    let div = document.createElement("div");
                    div.classList.add("dropdown-item");
                    div.textContent = item;
                    div.onclick = () => {
                        inputEl.value = item;
                        dropdownEl.style.display = "none";
                    };
                    dropdownEl.appendChild(div);
                });

                dropdownEl.style.display = items.length ? "block" : "none";
            });
    });

    // Hide dropdown when clicking outside
    document.addEventListener("click", e => {
        if (!e.target.closest(".typeahead")) {
            dropdownEl.style.display = "none";
        }
    });
}

// Initialize both fields
setupTypeahead("country_name", "country_dropdown", "/api/country_suggest");
setupTypeahead("university_name", "university_dropdown", "/api/university_suggest");

// Submission & Decision Field Logic
document.getElementById("status").addEventListener("change", function () {
    const status = this.value;

    const submitEnabled = ["submitted", "admitted", "rejected"].includes(status);
    const decisionEnabled = ["admitted", "rejected"].includes(status);

    document.getElementById("date_submitted").disabled = !submitEnabled;
    document.getElementById("time_submitted").disabled = !submitEnabled;
    document.getElementById("decision_date").disabled = !decisionEnabled;

    if (!submitEnabled) {
        document.getElementById("date_submitted").value = "";
        document.getElementById("time_submitted").value = "";
    }

    if (!decisionEnabled) {
        document.getElementById("decision_date").value = "";
    }
});
</script>


{% endblock %}
